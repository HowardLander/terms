<!DOCTYPE html>
<html lang="en">



    <head>

        <title>NIDM-Terms: Add Terms</title>

        <script src= "https://code.jquery.com/jquery-3.5.1.js"></script> 
        <script src="./js_lib/jquery.treeView.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsonld@1.0.0/dist/jsonld.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    </head>


    <body>

        <div class="about">
            <form action = "https://github.com/NIDM-Terms/terms" target="_blank">
                <button class= "github">Github <i class="fa fa-github" style="font-size:17px"></i>
                </button>
            </form>
            <form action = "https://scicrunch.org/nidm-terms/about/project" target="_blank">
               <button  class= "website">NIDM Website</button>
            </form>
            <form action = "http://nidm.nidash.org/" target="_blank">
                <button class = "nidmSpecs"> NIDM Specs</button>
            </form>
            <form action ="https://github.com/incf-nidash/PyNIDM" target= "_blank" >
                <button class= "pyNidm"> PyNIDM</a>
            </form>
        </div>
    
    
        <header>
            <div class= "logo">
                <img src="img/nidm-terms_576163.png" width= "85" height="85">
            </div>
            <div class="inner">
                <h>NIDM-Terms</h>
            </div>
            <div class="bidsTitle">
                <h> BIDS Specification Terms</h>
            </div>
        </header>
    
        <div>
            <nav>
                <ul class= "menuUl"><center>
    
                    <li class= "menuLi">
                        <form action= "index.html">
                            <button class = "available_terms" type="submit">Available Terms</button>
                        </form>
                    </li>
                
                    <li class= "menuLi">
                        <form action= "addNewTerm.html">
                            <button class = "add_terms" type="submit">Add New Terms</button>
                        </form>
                    </li>
    
                    <li class= "menuLi">
                        <form action="createTable.html">
                            <button class = "createTable">Export Terms</button>
                        </form>
                    </li>
    
                    <li class= "menuLi">
                        <form action="info.html">
                            <button class = "resources">About</button>
                        </form> 
                    </li>
    
                    <center><hr id="menuLine"></center>
    
                </center></ul>
    
            </nav>
        </div>

        <center><div class="container">

            <div class="headerBrdr"><center>
                STEP 1: fill out the following information
            </center></div>


            <form class="inputs">
                
                <h4>Label</h4>
                <input id= "label" class="TermInput" type="text" name="label" placeholder = "REQUIRED: Term in cammelCase (e.g. durationTime, author)" required>
                
                <h4>Description</h4>
                <input id= "des" class="TermInput" type="text" name="description" placeholder = "REQUIRED: Term description" required>
            

                <h4>Comment</h4>
                <input id= "comment" class="TermInput" type="text" name="comment" placeholder = "RECOMMENDED: Additional comments">
            

                <h4>URL</h4>
                <input id="url" class="TermInput" type="text" name="url" placeholder = "RECOMMENDED: Term URL">

                <h4>Unit</h4>
                <input id="unit" class="TermInput" type="text" name="unit" placeholder = "RECOMMENDED: Term unit">

                
                <label><h4>Value Type</h4></label>

                    <select name="valueType" id="VT" class="VT">
                        <option value="select">--select--</option>
                        <option value="string">string</option>
                        <option value="boolean">boolean</option>
                        <option value="integer">integer</option>
                        <option value="float">float</option>
                        <option value="double">double</option>
                        <option value="duration">duration</option>
                        <option value="dateTime">dateTime</option>
                        <option value="time">time</option>
                        <option value="date">date</option>
                        <option value="anyURI">anyURI</option>
                        <option value="complexType">complexType</option>
                    </select>

                
                <h4>OPTIONAL: categorical variables</h4>


                <div id="wrapper">

                    <br>

                        <form>
                            <h5>Please enter the number of values: <input id="numOfValues" class="numOfValues" type="text"> </h5>
                            <button type = "button" class= "btn3" id = "catValue"> Add Choice </button>
                        </form>

                        <div id= "addParent">
                            <div id= "add"></div>
                        </div>

                    <br>

                </div>

                <br><br><br>

                <div id='remove'><button class= "btn1" type = "button" onclick= "nextStep()"> Next </button></div>

                <br>

            </form>
            

            <div id="PR">

                

            </div>

        </div></center>



    </body>

    <footer>
        <hr id = "footer">
        <p><center>This project was supported by the National Institutes of Mental Health (NIMH) grant 1RF1MH120021</center></p>
    </footer>

    <style>
        .about{
            color: #52575e;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        .github{
            float: right;
            padding: 20px;
            margin-right: 10px;
            margin-top: 56px;
            color: #52575e;
            font-size: 14px;
            width: 130px;
            height:50px;
        }

        .github:hover{
            color: #32e17c;
            transition: 0.1s;
        }
        
        .website{
            float: right;
            margin-top: 61px;
            color: #52575e;
            font-size: 14px;
            width: 130px;
            height:50px;
        }

        .website:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .nidmSpecs{
            float: right;
            margin-top: 61px;
            color: #52575e;
            font-size: 14px;
            width: 130px;
            height:50px;
        }

        .nidmSpecs:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .pyNidm{
            float: right;
            margin-top: 61px;
            color: #52575e;
            font-size: 14px;
            width: 130px;
            height:50px;
        }

        .pyNidm:hover{
            color: #32e17c;
            transition: 0.1s;
        }

        .inner{
            margin: 40px;
            padding-top: 20px;
            padding-left: 124px;
            font-weight:lighter;
            font-size: 30px;
            font-family: serif;
            text-transform: uppercase;
            color: #a6a6a6;
        }
        .logo{
            position: absolute;
            top: 30px;
            left: 60px;
        }

        header{
            width: 100%;

        }

        .bidsTitle{
            color: white;
            background-size: 100px;
            background-color: #52575e;
            font-size: 40px;
            text-indent: 100px;
            padding-top: 20px;
            padding-left: 60px;
            padding-bottom: 20px;
        }

        .search_bar{
            float: right;
            margin-top: -47px;
            margin-right: 50px;
            border: 2px solid #32e17c;
            height: 45px;
            width: 325px;
            border-radius: 5px;
            background-color: #fefcfb;
            font-size: 18px;
            text-indent: 44px;
            outline: none;
        } 

        #searchIcon{
        color: #828486;
        float: right;
        margin-top: -35px;
        margin-right: -38px;
        }

        body {
            background-color: #ffffff;
        }

        .menuUl{
            width: auto;
            margin-top: 70px;
        }

        .menuLi{
            display: inline-block;
            padding: 20px 10px;
        }

        button{
            width: 250px;
            height: 60px;
            background-color: transparent;
            border: transparent;
            border-radius: 0px;
            font-size: 18px;
            font-weight:bold;
            cursor: pointer;
            outline: none;
        }

        .available_terms{
            color: #EA2027;
            
        }
        .available_terms:hover{
            border: 2px solid #EA2027;
            border-radius: 5px;
        }

        .add_terms{
            color: #EE5A24;
            border: 2px solid #EE5A24;
            border-radius: 5px;
        }
        
        .createTable{
            color: #F79F1F;
        }
        .createTable:hover{
            border: 2px solid #F79F1F;
            border-radius: 5px;

        }

        .resources{
            color: #FFC312;
        }
        .resources:hover{
            border: 2px solid #FFC312;
            border-radius: 5px;

        }

        #menuLine{
            height: 10px;
            background-image: linear-gradient(
                to right, 
                #EA2027, 
                #EE5A24, 
                #F79F1F, 
                #FFC312
                );
            margin-top: -23px;
            width: 1200px;
        }

        .container{
            width: 875px;
            height: 170%;
            text-align: left;
            font-family:Arial, Helvetica, sans-serif;
            border: 1px solid #b3b3b3 ;
            border-radius: 0px;
            padding: 80px;
            padding-top: 80px;
            padding-right: -10px;
            margin-top: 50px;
            margin-bottom: 100px;
            background-color: #F7F7F7 ;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);

        }

        .headerBrdr{
            font-size: 30px;
            text-indent: 34px;
            color: #7e7e7e;
            font-weight: bold;
        }

        .git{
            height: 45px;
            width: 40%;
            border-radius: 5px;
            border-color: #7e7e7e;
            padding: 0px 20px;
            background-color: #fdfdfd;
            font-size: 18px;
            text-indent: 20px;
            outline: none;
            font-size: 16px;
            margin-top: -25px;
            margin-bottom: 30px;
        }
    
        .TermInput{
            height: 45px;
            width: 90%;
            border-radius: 5px;
            border-color: #7e7e7e;
            padding: 0px 20px;
            background-color: #fdfdfd;
            font-size: 18px;
            text-indent: 20px;
            outline: none;
            font-size: 16px;
            margin-top: -25px;
            margin-bottom: 30px;

        }

        .inputs{
            padding-top: 50px;
            padding-left: 75px;
        }

        .subTermInput{
            height: 35px;
            width: 30%;
            border-radius: 5px;
            border-color: #7e7e7e;
            padding: 0px 20px;
            background-color: #fdfdfd;
            font-size: 18px;
            text-indent: 10px;
            outline: none;
            font-size: 16px;
            margin-left: 35px;
            margin-top: 5px;
            margin-bottom: 30px;
        }

        .VT{
            height: 53px;
            width: 95.5%;
            border-radius: 5px;
            border-color: #7e7e7e;
            border: 2px solid #696969;
            background-color: #fdfdfd;
            font-size: 18px;
            text-indent: 20px;
            outline: none;
            font-size: 16px;
            margin-top: -25px;
            margin-bottom: 30px;
            
            background-color: #f9f9f9;
            min-width: 160px;
            padding: 12px 16px;
        }

        #name{
            float: left;
            margin-left: 30px;
        }

        #value{
            float:right;
            margin-left: 40px;
        }
        

        #wrapper{
            text-indent: 0px;
            border: 2px solid #7e7e7e;
            border-radius: 5px;
            background-color: #fdfdfd;
            width: 92%;
            padding-top: 20px;
            padding-left: 30px;
            padding-bottom: 8%;
        }

        .btn{
            margin-top: -30px;
        }

        .btn1{
            float: right;
            cursor: pointer;
            width: 200px;
            height: 50px;
            background-color: #fefcfb;
            border: 2px solid #EE5A24;
            border-radius: 5px;
            font-size: 18px;
            color: #EE5A24;
        }

        .btn1:active {
            background: #e5e5e5;
            -webkit-box-shadow: inset 0px 0px 5px #96161a;
                -moz-box-shadow: inset 0px 0px 5px #96161a;
                    box-shadow: inset 0px 0px 5px #96161a;
            outline: none;

        }
        .btn1:hover{
            color:#fefcfb;
            background-image: linear-gradient(
            to right, 
            #EE5A24, 
            #F79F1F
            );
            border: none;
        }

        .btn2{
            float: left;
            cursor: pointer;
            width: 285px;
            height: 50px;
            background-color: #fefcfb;
            border: 2px solid #EE5A24;
            border-radius: 5px;
            font-size: 18px;
            color: #EE5A24;
            margin-top: -36px;
        }

        .btn2:active {
            background: #e5e5e5;
            -webkit-box-shadow: inset 0px 0px 5px #791316;
                -moz-box-shadow: inset 0px 0px 5px #791316;
                    box-shadow: inset 0px 0px 5px #791316;
            outline: none;
        }

        .btn2:hover{
            color:#fefcfb;
            background-image: linear-gradient(
            to right, 
            #EE5A24, 
            #F79F1F
            );
            border: none;
        }

        .btn3{
            float: right;
            cursor: pointer;
            width: 120px;
            height: 30px;
            background-color: #e7e7e7;
            border: 1px solid #52575e;
            border-radius: 5px;
            font-size: 14px;
            color: #52575e;
            margin-top: 0px;
            margin-right: 60px;
        }
        .btn3:hover{
            border: 2px solid #52575e;
        }
        .btn3:active {
            background: #e5e5e5;
        }

        h4{
            color: #52575e;
            font-weight:bold;
            font-size: 20px;
            text-indent: 20px;
        }

        h5{
            color: #52575e;
            font-weight:bold;
            font-size: 16px;
            text-indent: 30px; 
            display: inline;
        }

        #footer{
            height: 3px;
            background-image: linear-gradient(
                to right, 
                #EA2027, 
                #EE5A24, 
                #F79F1F, 
                #FFC312
                );
            width: 100%;
        }

    </style>

    <script>


        var email = {
            "name": "sanu",
            "repo": "terms"
        };


        $(document).ready(function() {
            $.ajax({
                url: "https://api.github.com/repos/nqueder/terms/pulls",
                type: "GET",
                success: function(result) {
                    console.log(result);
                },
                error: function(error) {
                    console.log(error);
                }
            });

        }) 

        ///////////////////////////////////////////////////////////////////////////
        //validat that label and description have values
        ///////////////////////////////////////////////////////////////////////////
        function nextStep(){

            // fetch the BIDS_Terms.jsonld file and read as a dictionary
            fetch("https://raw.githubusercontent.com/nqueder/terms/master/terms/BIDS_Terms.jsonld")
            .then(function(resp){
                return resp.json(); 
            })

            .then(function(termsDict){
                //lets to contain the available labels
                var avLabelList = [];

                for (var t in termsDict['terms']) {

                    var label = termsDict.terms[t].label;

                    avLabelList.push(label.toLowerCase())

                }
                return avLabelList

            })
            
            .then(function(avLabelList){
                //if label and description don't have values call the validation fonction
                if (document.getElementById('label').value.length == 0 & document.getElementById('des').value.length == 0){
                    alert('An input is required for Label and Description')
                }
                else if (document.getElementById('label').value.length == 0 & document.getElementById('des').value.length != 0){
                    alert('An input for Label is required')
                }
                else if (document.getElementById('label').value.length != 0 & document.getElementById('des').value.length == 0 ){
                    alert('An input for Description is required')
                }
                else if (document.getElementById('label').value.length != 0 & document.getElementById('des').value.length != 0 & avLabelList.includes(document.getElementById('label').value.toLowerCase()) == true){
                    window.alert('This term already exists in NIDM-Terms')
                    location.reload()
                }
                //else next step, which is an iput for the github API and a button 
                else {

                    $("#remove").html("")

                    html = '<br><br><hr><br><br><br><br>';

                    html += '<center><div class="headerBrdr"> STEP 2: enter your Github API Key <br><br></div>';
                    html += '<form class="inputs"><input class="TermInput" id = "token" type="text"  placeholder="GitHub API Token"></form>';
                    html += '<br><br><br>';
                    html += '<button class= "btn1"  onclick= "submitTerm()"> Send Pull Request </button>';
                    html += '<br></p></div></center>';  
                    
                    $('#PR').append(html);

                }
            })

            
        }


        ///////////////////////////////////////////////////////////////////////////
        /// function created to add choices if the term is a catagorical variable
        ///////////////////////////////////////////////////////////////////////////
        var list = [];
        function addOptions(){

            html = '<br><br><br><br>';

            var numOfOptions = document.getElementById('numOfValues').value;

            list.push(numOfOptions)

            if(document.getElementById('numOfValues').value != 0 & list.length == 1){

                for (var i = 1; i <= numOfOptions; i++){

                    html += '<h5>Choice '+i+':</h5>';
                    html += '<input id="n'+i+'" id="name" class="subTermInput" type="text" name="name" placeholder = "Name">';
                    html += '<input id="v'+i+'" id="value" class="subTermInput" type="text" name="value" placeholder = "Value">';
                    html += '<br>'
                        
                }

                $('#add').append(html);
            } 
            
            if (document.getElementById('numOfValues').value != 0 & list.length > 1){

                $("#add").html("");

                for (var i = 1; i <= numOfOptions; i++){

                    html += '<h5>Choice '+i+':</h5>';
                    html += '<input id="n'+i+'" id="name" class="subTermInput" type="text" name="name" placeholder = "Name">';
                    html += '<input id="v'+i+'" id="value" class="subTermInput" type="text" name="value" placeholder = "Value">';
                    html += '<br>'
                        
                }

                $('#add').append(html);

            }

            if (document.getElementById('numOfValues').value == 0){
                $("#add").html("");
            }

        };

        document.getElementById("catValue").addEventListener("click", addOptions)
        


        //////////////////////////////////////////////////////////////////////////////////
        /// function created to create jsonld files and submit a pull request to github
        //////////////////////////////////////////////////////////////////////////////////
        function submitTerm(){

            //empty dicttionary 
            var dict = {};
            var responseOption = {};
            
            // varable to assoctae with every term
            var associatedWith = ["BIDS","NIDM"];

            
            $(document).ready(function(event) { 
                // fetch the context file and create a jsonld
                fetch("https://raw.githubusercontent.com/nqueder/terms/master/context/cde_context.jsonld")
                .then(function(resp){
                    return resp.json(); 
                })

                .then(async function(context){

                    dict['@context'] = 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld'

                    //call checkTerm to checkif the lable of the term already exists to avoid duplication
                    //returns 1 if the terms exists and 0 if the term doesn't exist
                    //var check = checkLabel(document.getElementById("label").value)
                    //console.log(checkLabel(document.getElementById("label").value))

                    
                    
                    //assign inputted values to term properties
                    dict[context["@context"]["label"]] = document.getElementById("label").value;
                    if(document.getElementById("des").value.length != 0){
                        dict[context["@context"]["description"]] = document.getElementById("des").value;
                    }
                    if(document.getElementById("comment").value.length != 0){
                        dict[context["@context"]["comment"]] = document.getElementById("comment").value;
                    }
                    if(document.getElementById("url").value.length != 0){
                        dict[context["@context"]["url"]["@id"]] = document.getElementById("url").value;
                    }
                    if(document.getElementById("unit").value.length != 0){
                        responseOption[context["@context"]["unitCode"]] = document.getElementById("unit").value;
                    }
                    if(document.getElementById("VT").value.length != 0 & document.getElementById("VT").value != 'select'){
                        responseOption[context["@context"]["valueType"]] = document.getElementById("VT").value;
                    }
                    if(document.getElementById('numOfValues').value.length != 0){
                        //empty list for choices dictionaries
                        var choices_list = [];
                    
                        //get the number of choices available
                        var valNum = document.getElementById('numOfValues').value;
                        //loop through the choices and add them to add to the jsonld
                        for (var l = 1; l <= valNum; l++){
                            console.log(l)

                            // empty dictionary for each choice's name and value
                            var choices = {};

                            if(document.getElementById("n"+l).value.length != 0 & document.getElementById("v"+l).value.length != 0){
                                choices[context['@context']['name']] = document.getElementById("n"+l).value;
                                choices[context['@context']['value']] = document.getElementById("v"+l).value;
                                choices_list.push(choices)
                            }
                        }

                        //assign choices to responseOptions dictionary
                        if(choices_list.length != 0){
                            responseOption[context['@context']['choices']] = choices_list;
                        }

                    }    

                    //add response options values
                    if(Object.keys(responseOption).length != 0){
                        dict[context["@context"]["responseOptions"]["@id"]] = responseOption
                    }
                    //always associate the term with BIDS and NIDM
                    dict[context["@context"]["associatedWith"]] = associatedWith;


                    //compact term dictionary
                    const compacted = await jsonld.compact(dict, 'https://raw.githubusercontent.com/NIDM-Terms/terms/master/context/cde_context.jsonld');
                    console.log(compacted)
                        
                })

                .then( async function(newTermJsonld){


                    //need to convert the data to a file
                    var content = 'Insia2V5XzEiOiJzb21lIHRleHQiLCJrZXlfMiI6dHJ1ZSwia2V5XzMiOjV9Ig==';

                    console.log(content)

                    console.log(JSON.stringify(email))

                    await octokit.request('PUT /repos/nqueder/terms/contents/terms/Test.json', {
                        owner: 'nqueder',
                        repo: 'terms',
                        path: 'terms.Test.json',
                        message: 'New Commit',
                        content: content
                    });

                    // commit
                    // $(document).ready(function() {
                    //     $.ajax({
                    //         url: "https://api.github.com/repos/nqueder/terms/contents/terms/BIDS_Terms/Test.json",
                    //         type: "PUT",
                    //         headers: {
                    //             'Authorization': 'token ' + Token,
                    //             'Content-Type': 'application/json'
                    //         },
                    //         body:{
                    //             message: 'added a test file',
                    //             content: 'Insia2V5XzEiOiJzb21lIHRleHQiLCJrZXlfMiI6dHJ1ZSwia2V5XzMiOjV9Ig=='
                    //         },
                    //         success: function(result) {
                    //             console.log(result);
                    //         },
                    //         error: function(error) {
                    //             console.log(error);
                    //         }
                    //     });

                    // });

                })

            });

        };

        
        

    </script>


    
</html>
